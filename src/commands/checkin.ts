import axios from "axios";
import { listAddress } from "../constant";
import { deleteSession, setSession } from "../stores/session";
import { queryDb, runDb } from "../stores/database";
import { Context } from "telegraf";
import { isValidJWTFormat } from "../utils";
import { isNil } from "lodash";

// L·ªánh checkin
export const checkinCommand = async (ctx: Context) => {
  const userId = ctx.from?.id;
  if (!userId) return;

  await setSession(userId, { action: "checkin" });

  try {
    const row = await queryDb(`SELECT * FROM users WHERE user_id = ?`, [
      userId,
    ]);

    if (!row?.access_token) {
      return ctx.reply(
        "‚ö†Ô∏è B·∫°n ch∆∞a c√≥ access token. Vui l√≤ng g·ª≠i token c·ªßa b·∫°n ƒë·ªÉ ti·∫øp t·ª•c.",
      );
    }

    // Ki·ªÉm tra token h·∫øt h·∫°n
    const tokenParts = row.access_token.split(".");
    if (tokenParts.length !== 3) {
      return ctx.reply(
        "‚ùå Access token kh√¥ng h·ª£p l·ªá. Vui l√≤ng g·ª≠i l·∫°i token h·ª£p l·ªá.",
      );
    }

    const payload = JSON.parse(Buffer.from(tokenParts[1], "base64").toString());
    if (payload.exp < Date.now() / 1000) {
      return ctx.reply("‚è≥ Token ƒë√£ h·∫øt h·∫°n. Vui l√≤ng g·ª≠i token m·ªõi.");
    }

    const response = await requestCheckin(row.access_token);
    await deleteSession(userId);
    if (response?.data?.message) {
      return ctx.reply(response?.data?.message);
    } else {
      await runDb(`UPDATE users SET access_token = ? WHERE user_id = ?`, [
        null,
        userId,
      ]);
      console.log("L·ªói check-in kh√¥ng tr·∫£ v·ªÅ message");
      return ctx.reply("‚ùå L·ªói khi check-in");
    }
  } catch (err) {
    console.error("‚ùå L·ªói khi check-in:", err);
    await deleteSession(userId);
    return ctx.reply("‚ö†Ô∏è ƒê√£ c√≥ l·ªói x·∫£y ra khi check-in. Vui l√≤ng th·ª≠ l·∫°i sau.");
  }
};

export const checkin = async (ctx: any) => {
  const userId = ctx.from?.id;
  const messageText = ctx.message?.text;

  if (!isValidJWTFormat(messageText)) {
    await deleteSession(userId);
    return ctx.reply("üö´ Access token kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p l·∫°i.");
  }

  try {
    await runDb(`UPDATE users SET access_token = ? WHERE user_id = ?`, [
      messageText,
      userId,
    ]);

    const response = await requestCheckin(messageText);
    if (response?.response?.status === 400) {
      await deleteSession(userId);
      await runDb(`UPDATE users SET access_token = ? WHERE user_id = ?`, [
        null,
        userId,
      ]);
      return ctx.reply(
        "‚ùå Check-in th·∫•t b·∫°i! Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n.",
      );
    }

    await deleteSession(userId);
    if (response?.data?.message) {
      return ctx.reply(response?.data?.message);
    } else {
      await runDb(`UPDATE users SET access_token = ? WHERE user_id = ?`, [
        null,
        userId,
      ]);
      console.log("L·ªói check-in kh√¥ng tr·∫£ v·ªÅ message");
      return ctx.reply("‚ùå L·ªói khi check-in");
    }
  } catch (err) {
    console.error("‚ùå L·ªói khi check-in:", err);
    await deleteSession(userId);
    return ctx.reply("‚ö†Ô∏è C√≥ l·ªói x·∫£y ra khi check-in. Vui l√≤ng th·ª≠ l·∫°i sau.");
  }
};

// G·ªçi API checkin
export const requestCheckin = async (accessToken: string) => {
  try {
    const headers = {
      Host: "api-gateway.acheckin.io",
      "Access-Control-Allow-Origin": "*",
      "x-timestamp": `${Date.now() + 7 * 60 * 60 * 1000}`,
      provider: "GOOGLE",
      Accept: "*/*",
      Authorization: accessToken,
      "x-workspace-host": "mirailabs.acheckin.io",
      "x-signature":
        "soula0gjfOluN7mWztVxHpuBy0HzPF4EdrU4uuLjB0ZONDsjmBO3pEKtkxKt3hRI+F+VKoHf7uDqnmPhGzv+vg==",
      "Accept-Language": "en-GB,en-US;q=0.9,en;q=0.8",
      "x-workspace-id": "562c982f-3153-449e-98e8-f1431c434e9c",
      "User-Agent": "ACheckin%20HRM/15 CFNetwork/3826.400.120 Darwin/24.3.0",
      "x-device-id": "EC5638D2-39DA-4777-8394-A772567E1C80",
      Connection: "keep-alive",
      "Content-Type": "application/json",
    };

    const pickAddress =
      listAddress[Math.floor(Math.random() * listAddress.length)];
    const data = {
      latitude: pickAddress.latitude,
      longitude: pickAddress.longitude,
      device_name: "iPhone",
    };

    const response = await axios.post(
      "https://api-gateway.acheckin.io/v2/mobile/user-workspaces/checkin",
      data,
      { headers },
    );
    return response.data;
  } catch (error) {
    console.error("API call failed:", error);
    return error;
  }
};
